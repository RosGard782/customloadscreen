name: Build CustomLoadScreen

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw81'
        tools: 'tools_mingw,qt.tools.win64_mingw810'
    
    - name: Create missing header file
      run: |
        @"
        #ifndef CUSTOMLOADSCREEN_H
        #define CUSTOMLOADSCREEN_H
        
        #include <QObject>
        #include <d3d9.h>
        #include <QString>
        
        // Forward declarations
        class CFont;
        class CTexture;
        
        class CustomLoadScreen : public QObject
        {
            Q_OBJECT
        
        public:
            explicit CustomLoadScreen(QObject *parent = nullptr);
            ~CustomLoadScreen();
        
            void Loop();
            bool Event(UINT uMsg, WPARAM wParam, LPARAM lParam);
            HRESULT Present(const RECT *pSourceRect, const RECT *pDestRect,
                           HWND hDestWindowOverride, const RGNDATA *pDirtyRegion);
        
        private:
            bool init = false;
            CFont* pFont;
            CTexture* pTexture;
        };
        
        #endif // CUSTOMLOADSCREEN_H
        "@ | Out-File -FilePath "CustomLoadScreen.h" -Encoding UTF8
      shell: powershell
    
    - name: Fix pro file
      run: |
        $content = Get-Content CustomLoadScreen.pro
        $content = $content -replace 'LIBS \+= -ld3d9 \\', ''
        $content = $content -replace '\s*-ld3dx9 \\', ''
        $content = $content -replace '\s*-lgdi32 \\', ''
        $content = $content -replace '\s*-luser32 \\', ''
        $content = $content -replace '\s*-
    
    - name: Generate Makefile
      run: qmake CustomLoadScreen.pro
    
    - name: Build project
      run: mingw32-make
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CustomLoadScreen-build
        path: |
          *.asi
          *.dll
          *.exe
        retention-days: 30, ''
        $content += "" 
        $content += "LIBS += -ld3d9 -ld3dx9 -lgdi32 -luser32"
        $content += ""
        $content += "# Disable warnings as errors"
        $content += "QMAKE_CXXFLAGS += -Wno-error=unused-parameter"
        $content | Set-Content CustomLoadScreen.pro -Force
      shell: powershell
    
    - name: Generate Makefile
      run: qmake CustomLoadScreen.pro
    
    - name: Build project
      run: mingw32-make
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CustomLoadScreen-build
        path: |
          *.asi
          *.dll
          *.exe
        retention-days: 30
